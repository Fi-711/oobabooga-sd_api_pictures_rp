## Description:
TL;DR: Lets the bot answer you with a picture!
Improved version of: https://github.com/oobabooga/text-generation-webui/blob/main/extensions/sd_api_pictures/README.MD

Stable Diffusion API pictures for TextGen, v.1.0 
An extension to [oobabooga's textgen-webui](https://github.com/oobabooga/text-generation-webui) allowing you to receive pics generated by [Automatic1111's SD-WebUI API](https://github.com/AUTOMATIC1111/stable-diffusion-webui)

## Improvements
1. Settings Json to store all settings for characters and models
2. Improved UI so can now use Loras abd save character presets
3. By adding square brackets to {{user}} input, you can now geenrate the image your end! You must select the new button "generate image" to make your image rather than the standard generate button

e.g. [blue dog] hello!
In the above example, an image of a blue dog will be drawn. The text "hello" will be sent to the AI model.

## Further improvements
Want to use enter rather than scrolling down to the new button?
Follow these steaps:
1. Save a copy of server.py which should be in the main folder
2. Add this line to the top as an import
```
# function to generate pictures, used below to change what submit does when submitting chat input
from extensions.sd_api_pictures_rp.script import generate_picture
```
3. Find the commented out lines below (lines with hashes) and comment it out (by adding hashes to them), then add the new lines below it:
```
# gen_events.append(shared.gradio['textbox'].submit(
#     ui.gather_interface_values, [shared.gradio[k] for k in shared.input_elements], shared.gradio['interface_state']).then(
#     lambda x: (x, ''), shared.gradio['textbox'], [shared.gradio['Chat input'], shared.gradio['textbox']], show_progress=False).then(
#     chat.generate_chat_reply_wrapper, shared.input_params, shared.gradio['display'], show_progress=False).then(
#     chat.save_history, shared.gradio['mode'], None, show_progress=False).then(
#     lambda: None, None, None, _js=f"() => {{{audio_notification_js}}}")
# )

# replace submit handler for use with sd_api_pictures_rp
gen_events.append(shared.gradio['textbox'].submit(
    ui.gather_interface_values, [shared.gradio[k] for k in shared.input_elements], shared.gradio['interface_state']).then(
    lambda x: (generate_picture(x), ''), inputs=[shared.gradio['textbox']], outputs=[shared.gradio['Chat input'], shared.gradio['textbox']], show_progress=False).then(
    chat.generate_chat_reply_wrapper, shared.input_params, shared.gradio['display'], show_progress=False).then(
    chat.save_history, shared.gradio['mode'], None, show_progress=False)
)

```


<details>
<summary>Interface overview</summary>

![Interface](https://raw.githubusercontent.com/Brawlence/SD_api_pics/main/illust/Interface.jpg)

</details>

Load it in the `--chat` mode with `--extension sd_api_pictures` alongside `send_pictures`
(it's not really required, but completes the picture, *pun intended*).  


## History

Consider the version included with [oobabooga's repository](https://github.com/oobabooga/text-generation-webui/tree/main/extensions/sd_api_pictures) to be STABLE, experimental developments and untested features are pushed in [Brawlence/SD_api_pics](https://github.com/Brawlence/SD_api_pics)

Lastest change:  
1.1.0 â†’ 1.1.1 Fixed not having Auto1111's metadata in received images

## Details

The image generation is triggered:  
- manually through the 'Force the picture response' button while in `Manual` or `Immersive/Interactive` modes OR  
- automatically in `Immersive/Interactive` mode if the words `'send|main|message|me'` are followed by `'image|pic|picture|photo|snap|snapshot|selfie|meme'` in the user's prompt  
- always on in `Picturebook/Adventure` mode (if not currently suppressed by 'Suppress the picture response')  

## Prerequisites

One needs an available instance of Automatic1111's webui running with an `--api` flag. Ain't tested with a notebook / cloud hosted one but should be possible.   
To run it locally in parallel on the same machine, specify custom `--listen-port` for either Auto1111's or ooba's webUIs.  

## Features overview
- Connection to API check (press enter in the address box)  
- [VRAM management (model shuffling)](https://github.com/Brawlence/SD_api_pics/wiki/VRAM-management-feature)  
- [Three different operation modes](https://github.com/Brawlence/SD_api_pics/wiki/Modes-of-operation) (manual, interactive, always-on)  
- User-defined persistent settings via settings.json

### Connection check

Insert the Automatic1111's WebUI address and press Enter:  
![API-check](https://raw.githubusercontent.com/Brawlence/SD_api_pics/main/illust/API-check.gif)  
Green mark confirms the ability to communicate with Auto1111's API on this address. Red cross means something's not right (the ext won't work).

### Persistents settings

Create or modify the `settings.json` in the `text-generation-webui` root directory to override the defaults
present in script.py, ex:

```json
{
    "sd_api_pictures-manage_VRAM": 1,
    "sd_api_pictures-save_img": 1,
    "sd_api_pictures-prompt_prefix": "(Masterpiece:1.1), detailed, intricate, colorful, (solo:1.1)",
    "sd_api_pictures-sampler_name": "DPM++ 2M Karras"
}
```